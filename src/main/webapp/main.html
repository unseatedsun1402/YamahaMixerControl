<!DOCTYPE html>
<html>
<head>
    <title>MidiControl UI</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/basic-view-style.css"/>

    <!-- Bootstrap -->
    <script type="module">
        import { WebSocketClient } from './js/websocketClient.js';
        import { renderUiModel } from './js/new-ui-renderer.js';
        import { applyControlUpdate } from './js/partial-update.js';

        console.log(">>> MidiControl UI bootstrap running <<<");

        // Build WebSocket URL
        const contextPath = window.location.pathname.split('/')[1];
        const wsUrl = `ws://${location.host}/${contextPath}/endpoint`;

        // Create WebSocket client
        const ws = new WebSocketClient(wsUrl);

        // -----------------------------
        // Event Handlers
        // -----------------------------

        ws.on("connected", () => {
            console.log("[Bootstrap] Connected — waiting for ui-bank…");
        });

        // 1. Receive the bank structure
        ws.on("ui-bank", (msg) => {
            console.log("[Bootstrap] Bank received:", msg);

            const bank = msg.payload;

            // Clear strip container
            const stripContainer = document.getElementById("strip-container");
            stripContainer.innerHTML = "";

            // Request + subscribe to each context
            for (const ctxId of bank.contexts) {
                console.log(`[Bootstrap] Requesting model for ${ctxId}`);
                ws.requestUiModel(ctxId);
                ws.subscribe(ctxId);
            }
        });

        // 2. Receive each full UI model
        ws.on("ui-model", (msg) => {
            console.log("[Bootstrap] UI model received:", msg);
            renderUiModel(msg.payload.model);
        });

        // 3. Receive incremental updates
        ws.on("control-update", (payload) => {
            console.log("[Bootstrap] Control update:", payload);
            applyControlUpdate(payload);
        });

        // Error handler
        ws.on("error", (err) => {
            console.error("[Bootstrap] Error from server:", err);
        });

        // Start connection
        ws.connect();

        // Expose globally for widgets
        window.wsClient = ws;
    </script>
</head>

<body>
    <div id="ui-root">
        <div id="strip-container"></div>
    </div>
</body>

</html>